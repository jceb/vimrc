#!/bin/sh
set -e
if quilt top &>/dev/null; then
    echo 'Unapplying patches'
    quilt pop -a
fi

echo 'Pulling changes'
git pull --rebase

echo 'Pulling submodules'
git submodule foreach git checkout master
git submodule foreach git pull --rebase

echo 'Committing changes'
git add -u
git commit -m "Update plugins" || true
git push

echo 'Applying patches'
quilt push -a

echo 'Updating chaches'
/usr/bin/nvim -c 'packloadall|exec "silent! UpdateRemotePlugins"|exec "silent! helptags ALL"|q'

echo "Update finished"
